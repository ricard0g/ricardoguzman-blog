---
import type { CollectionEntry } from "astro:content";
import Post from "./Post.astro";

type BlogPost = CollectionEntry<"blogCollection">;

interface Props {
	title: string;
	posts: BlogPost[];
	currentPage?: number;
	totalPages?: number;
	basePath?: string;
}

const {
	title,
	posts,
	currentPage = 1,
	totalPages = 1,
	basePath = "/blog",
} = Astro.props as Props;

const safeCurrentPage = Math.min(Math.max(currentPage, 1), Math.max(totalPages, 1));

const getPageHref = (page: number) => {
	return page === 1 ? basePath : `${basePath}/${page}`;
};

const getVisiblePageNumbers = () => {
	if (totalPages <= 3) {
		return Array.from({ length: totalPages }, (_, index) => index + 1);
	}

	if (safeCurrentPage <= 2) {
		return [1, 2, 3];
	}

	if (safeCurrentPage >= totalPages - 1) {
		return [totalPages - 2, totalPages - 1, totalPages];
	}

	return [safeCurrentPage - 1, safeCurrentPage, safeCurrentPage + 1];
};

const visiblePageNumbers = getVisiblePageNumbers();
const showLeadingEllipsis = totalPages > 3 && visiblePageNumbers[0] > 1;
const showTrailingEllipsis =
	totalPages > 3 && visiblePageNumbers[visiblePageNumbers.length - 1] < totalPages;
---

<section
	id="recent-posts"
	class="flex flex-col items-center justify-center w-[90%] md:w-[35%] m-auto mb-[100px]"
>
	<h2
		class="gradient-heading text-3xl text-center tracking-wide leading-[1.2] bg-gradient-to-r from-[#444] to-primary-dark-text dark:from-primary-dark-text dark:to-[#444] bg-clip-text text-transparent transition-all duration-75 mb-10"
	>
		{title}
	</h2>
	<div class="flex flex-col items-center justify-center w-full gap-2">
		{posts.map((post) => <Post post={post} />)}
	</div>
	{
		totalPages > 1 && (
			<nav
				aria-label="Blog pagination"
				class="m-8 flex items-center justify-center gap-2 text-sm md:text-base"
			>
				{
					safeCurrentPage > 1 ? (
						<a
							href={getPageHref(safeCurrentPage - 1)}
							aria-label="Previous page"
							class="px-3 py-1 rounded-md border border-primary-dark-border/30 dark:border-primary-light-border/30 hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
						>
							←
						</a>
					) : (
						<span
							aria-disabled="true"
							class="px-3 py-1 rounded-md border border-primary-dark-border/20 dark:border-primary-light-border/20 opacity-40 cursor-not-allowed"
						>
							←
						</span>
					)
				}

				{showLeadingEllipsis && <span class="px-1 opacity-60">...</span>}

				{
					visiblePageNumbers.map((page) =>
						page === safeCurrentPage ? (
							<span
								aria-current="page"
								class="px-3 py-1 rounded-md border border-primary-dark dark:border-primary-light font-semibold"
							>
								{page}
							</span>
						) : (
							<a
								href={getPageHref(page)}
								class="px-3 py-1 rounded-md border border-primary-dark-border/30 dark:border-primary-light-border/30 hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
							>
								{page}
							</a>
						)
					)
				}

				{showTrailingEllipsis && <span class="px-1 opacity-60">...</span>}

				{
					safeCurrentPage < totalPages ? (
						<a
							href={getPageHref(safeCurrentPage + 1)}
							aria-label="Next page"
							class="px-3 py-1 rounded-md border border-primary-dark-border/30 dark:border-primary-light-border/30 hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
						>
							→
						</a>
					) : (
						<span
							aria-disabled="true"
							class="px-3 py-1 rounded-md border border-primary-dark-border/20 dark:border-primary-light-border/20 opacity-40 cursor-not-allowed"
						>
							→
						</span>
					)
				}
			</nav>
		)
	}
</section>
